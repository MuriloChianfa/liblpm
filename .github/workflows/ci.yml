name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Build and test on multiple platforms
  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [DEBUG, RELEASE]
        compiler: [gcc, clang]
        include:
          - build_type: DEBUG
            compiler: gcc
          - build_type: RELEASE
            compiler: gcc
          - build_type: DEBUG
            compiler: clang
          - build_type: RELEASE
            compiler: clang

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake cppcheck valgrind
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt install -y clang
        fi

    - name: Configure and build
      run: |
        mkdir build
        cd build
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DBUILD_TESTS=ON \
                -DBUILD_BENCHMARKS=ON \
                -DENABLE_NATIVE_ARCH=OFF \
                ..
        else
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER=gcc \
                -DCMAKE_CXX_COMPILER=g++ \
                -DBUILD_TESTS=ON \
                -DBUILD_BENCHMARKS=ON \
                -DENABLE_NATIVE_ARCH=OFF \
                ..
        fi
        make -j$(nproc)

    - name: Run unit tests
      run: |
        cd build
        ctest -L unit --verbose --output-on-failure

    - name: Run fuzzing tests
      run: |
        cd build
        ctest -L fuzz --verbose --output-on-failure

    - name: Run static analysis
      run: |
        cd build
        ctest -L static_analysis --verbose --output-on-failure

    - name: Run all tests
      run: |
        cd build
        ctest --verbose --output-on-failure

  # Test on macOS
  test-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [RELEASE]
        # build_type: [DEBUG, RELEASE]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake cppcheck

    - name: Configure and build
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DBUILD_TESTS=ON \
              -DBUILD_BENCHMARKS=ON \
              -DENABLE_NATIVE_ARCH=OFF \
              ..
        make -j$(sysctl -n hw.ncpu)

    - name: Run all tests
      run: |
        cd build
        ctest --verbose --output-on-failure

  # Memory leak detection with Valgrind (Linux only)
  test-valgrind:
    runs-on: ubuntu-latest
    needs: test-linux

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake valgrind

    - name: Configure and build
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=DEBUG \
              -DBUILD_TESTS=ON \
              -DBUILD_BENCHMARKS=ON \
              -DENABLE_NATIVE_ARCH=OFF \
              ..
        make -j$(nproc)

    - name: Run tests with Valgrind
      run: |
        cd build
        # Run each test with Valgrind to check for memory leaks
        for test in test_basic test_lookup_all test_fuzz test_fuzz_advanced; do
          if [ -f "$test" ]; then
            echo "Running $test with Valgrind..."
            valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
                     --error-exitcode=1 --suppressions=../tests/valgrind.supp \
                     ./$test
          fi
        done

  # Static analysis with multiple tools
  static-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake cppcheck

    - name: Configure for static analysis
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=DEBUG \
              -DBUILD_TESTS=ON \
              -DBUILD_BENCHMARKS=ON \
              -DENABLE_NATIVE_ARCH=OFF \
              ..

    - name: Run cppcheck
      run: |
        cd build
        ctest -L static_analysis --verbose --output-on-failure

  # Build verification with different configurations
  build-verification:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - name: "Shared library"
            options: "-DBUILD_SHARED_LIBS=ON"
          - name: "Static library"
            options: "-DBUILD_SHARED_LIBS=OFF"
          - name: "Native optimizations"
            options: "-DENABLE_NATIVE_ARCH=ON"
          - name: "No benchmarks"
            options: "-DBUILD_BENCHMARKS=OFF"
          - name: "No tests"
            options: "-DBUILD_TESTS=OFF"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake cppcheck

    - name: Configure and build (${{ matrix.config.name }})
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=RELEASE \
              ${{ matrix.config.options }} \
              ..
        make -j$(nproc)

    - name: Run tests (if enabled)
      run: |
        cd build
        if [ "${{ matrix.config.options }}" != "-DBUILD_TESTS=OFF" ]; then
          ctest --verbose --output-on-failure
        fi

  # Fuzzing with AFL (if available)
  fuzzing:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install AFL
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake afl++

    - name: Setup fuzzing environment
      run: |
        chmod +x tests/fuzz_setup.sh
        ./tests/fuzz_setup.sh

    - name: Build with AFL instrumentation
      run: |
        chmod +x build_afl.sh
        ./build_afl.sh

    - name: Run basic fuzzing
      run: |
        # Run a short fuzzing session to check for immediate crashes
        timeout 300s afl-fuzz -i fuzz_input -o fuzz_output -x tests/dict.txt \
          ./build_afl/test_fuzz_advanced @@ || true

    - name: Check for crashes
      run: |
        if [ -d "fuzz_output/crashes" ] && [ "$(ls -A fuzz_output/crashes)" ]; then
          echo "Fuzzing found crashes!"
          ls -la fuzz_output/crashes/
          exit 1
        else
          echo "No crashes found during fuzzing session"
        fi

  # Code coverage (only on main branch)
  coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake lcov cppcheck

    - name: Configure with coverage
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=DEBUG \
              -DCMAKE_C_FLAGS="-fprofile-arcs -ftest-coverage" \
              -DBUILD_TESTS=ON \
              -DBUILD_BENCHMARKS=ON \
              -DENABLE_NATIVE_ARCH=OFF \
              ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run tests with coverage
      run: |
        cd build
        ctest --verbose --output-on-failure

    - name: Generate coverage report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: build/coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
