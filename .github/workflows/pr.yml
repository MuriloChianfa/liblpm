name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Quick build and test for PRs
  pr-checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [DEBUG, RELEASE]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake cppcheck

    - name: Configure and build
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DBUILD_TESTS=ON \
              -DBUILD_BENCHMARKS=ON \
              -DENABLE_NATIVE_ARCH=OFF \
              ..
        make -j$(nproc)

    - name: Run unit tests
      run: |
        cd build
        ctest -L unit --verbose --output-on-failure

    - name: Run static analysis
      run: |
        cd build
        ctest -L static_analysis --verbose --output-on-failure

    - name: Run basic fuzzing tests
      run: |
        cd build
        ctest -L fuzz --verbose --output-on-failure

  # Man page linting
  lint-manpages:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install mandoc
      run: sudo apt-get update && sudo apt-get install -y mandoc

    - name: Lint man pages
      run: ./scripts/lint-manpages.sh

  # TODO: Add macOS support once libdynemit supports AppleClang or we configure GCC
  # pr-macos:
  #   runs-on: macos-latest
  #   steps:
  #     - Requires GCC 13+ for C23 support in libdynemit
